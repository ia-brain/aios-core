# STORY 3.8: Template ADR

**ID:** 3.8 | **Epic:** [EPIC-S3](../../../epics/epic-s3-quality-templates.md)
**Sprint:** 3 | **Points:** 3 | **Priority:** üü† High | **Created:** 2025-01-19
**Updated:** 2025-12-03
**Status:** üìã Draft

**Reference:** [Decis√£o 9 - Template Engine](../../../audits/PEDRO-DECISION-LOG.md#decis√£o-9)

**Predecessor:** Story 3.6 (Template Engine Core) ‚è≥

---

## User Story

**Como** Architect (Aria),
**Quero** template ADR (Architecture Decision Record) em formato Handlebars,
**Para que** possa documentar decis√µes arquiteturais de forma padronizada e rastre√°vel.

---

## Acceptance Criteria

### Template Structure
- [ ] AC3.8.1: Template segue padr√£o ADR (Context, Decision, Consequences)
- [ ] AC3.8.2: Suporta status: Proposed, Accepted, Deprecated, Superseded
- [ ] AC3.8.3: Se√ß√£o de alternatives com pros/cons estruturados
- [ ] AC3.8.4: Numera√ß√£o autom√°tica baseada em ADRs existentes

### Validation
- [ ] AC3.8.5: JSON Schema valida output gerado
- [ ] AC3.8.6: Valida que decision n√£o est√° vazia

### Integration
- [ ] AC3.8.7: Template registrado no TemplateEngine
- [ ] AC3.8.8: Gera√ß√£o via CLI: `aios generate adr`

---

## Scope

### Template Location
`.aios-core/product/templates/adr.hbs`

### Template Structure

```handlebars
---
template_id: adr
template_name: Architecture Decision Record
version: 1.0
variables:
  - name: number
    type: number
    required: true
    prompt: "N√∫mero do ADR (ex: 001):"
    auto: next_adr_number
  - name: title
    type: string
    required: true
    prompt: "T√≠tulo da decis√£o arquitetural:"
  - name: status
    type: choice
    required: true
    choices: [Proposed, Accepted, Deprecated, Superseded]
    default: Proposed
  - name: deciders
    type: string
    required: true
    prompt: "Quem participou da decis√£o? (nomes separados por v√≠rgula):"
  - name: context
    type: text
    required: true
    prompt: "Qual √© o contexto e problema que gerou essa decis√£o?"
  - name: decision
    type: text
    required: true
    prompt: "Qual √© a decis√£o tomada?"
  - name: positiveConsequences
    type: array
    required: true
    prompt: "Quais s√£o as consequ√™ncias positivas?"
  - name: negativeConsequences
    type: array
    required: false
    prompt: "Quais s√£o as consequ√™ncias negativas (trade-offs)?"
  - name: alternatives
    type: array
    required: false
---

# ADR {{padNumber number 3}}: {{title}}

**Status:** {{status}}
**Date:** {{formatDate now "YYYY-MM-DD"}}
**Deciders:** {{deciders}}

---

## Context

{{context}}

---

## Decision

{{decision}}

---

## Consequences

### Positive

{{#each positiveConsequences}}
- ‚úÖ {{this}}
{{/each}}

### Negative

{{#if negativeConsequences}}
{{#each negativeConsequences}}
- ‚ö†Ô∏è {{this}}
{{/each}}
{{else}}
_No significant negative consequences identified._
{{/if}}

---

{{#if alternatives}}
## Alternatives Considered

{{#each alternatives}}
### Option {{add @index 1}}: {{this.name}}

{{this.description}}

| Aspect | Details |
|--------|---------|
| **Pros** | {{this.pros}} |
| **Cons** | {{this.cons}} |
| **Why Not Chosen** | {{this.whyNot}} |

{{/each}}
{{/if}}

---

## Related Decisions

{{#if relatedADRs}}
{{#each relatedADRs}}
- [ADR {{this.number}}](./adr-{{padNumber this.number 3}}.md): {{this.title}}
{{/each}}
{{else}}
_No related decisions._
{{/if}}

---

## References

{{#if references}}
{{#each references}}
- {{this}}
{{/each}}
{{else}}
_No external references._
{{/if}}

---

**Generated by:** AIOS Template Engine v2.0
**Template Version:** adr-1.0
```

### JSON Schema

`.aios-core/product/templates/engine/schemas/adr.schema.json`:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ADR Template Variables",
  "type": "object",
  "required": ["number", "title", "status", "deciders", "context", "decision", "positiveConsequences"],
  "properties": {
    "number": { "type": "integer", "minimum": 1 },
    "title": { "type": "string", "minLength": 5, "maxLength": 100 },
    "status": {
      "type": "string",
      "enum": ["Proposed", "Accepted", "Deprecated", "Superseded"]
    },
    "deciders": { "type": "string", "minLength": 1 },
    "context": { "type": "string", "minLength": 20 },
    "decision": { "type": "string", "minLength": 20 },
    "positiveConsequences": {
      "type": "array",
      "minItems": 1,
      "items": { "type": "string" }
    },
    "negativeConsequences": {
      "type": "array",
      "items": { "type": "string" }
    },
    "alternatives": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "description"],
        "properties": {
          "name": { "type": "string" },
          "description": { "type": "string" },
          "pros": { "type": "string" },
          "cons": { "type": "string" },
          "whyNot": { "type": "string" }
        }
      }
    }
  }
}
```

---

## Tasks

### Design (2h)
- [ ] 3.8.1: Design ADR structure
  - [ ] 3.8.1.1: Research ADR best practices (Michael Nygard format)
  - [ ] 3.8.1.2: Review existing ADRs in codebase
  - [ ] 3.8.1.3: Define required vs optional sections

### Implementation (3h)
- [ ] 3.8.2: Create Handlebars template (2h)
  - [ ] 3.8.2.1: Create base template with required sections
  - [ ] 3.8.2.2: Add alternatives section (optional)
  - [ ] 3.8.2.3: Add helper for zero-padded numbers
- [ ] 3.8.3: Create JSON Schema (1h)

### Testing (2h)
- [ ] 3.8.4: Test with real architectural decisions
  - [ ] 3.8.4.1: Generate ADR for existing decision
  - [ ] 3.8.4.2: Test with alternatives
  - [ ] 3.8.4.3: Validate schema enforcement

**Total Estimated:** 7h (~1 day)

---

## Dev Notes

### ADR Standard Reference
Based on Michael Nygard's ADR format: https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions

### Existing ADRs Location
- `docs/architecture/decisions/` (if exists)
- `docs/audits/` (contains decision logs)

### Handlebars Helpers Required
```javascript
// padNumber helper (for ADR-001 format)
Handlebars.registerHelper('padNumber', (num, length) => {
  return String(num).padStart(length, '0');
});

// add helper (for index + 1)
Handlebars.registerHelper('add', (a, b) => a + b);
```

### Auto-numbering Logic
```javascript
// Determine next ADR number by scanning existing files
async function getNextADRNumber() {
  const files = await glob('docs/architecture/decisions/adr-*.md');
  const numbers = files.map(f => parseInt(f.match(/adr-(\d+)/)[1]));
  return Math.max(...numbers, 0) + 1;
}
```

### Testing

| Test ID | Name | Priority |
|---------|------|----------|
| ADR-01 | Generate ADR with required fields | P0 |
| ADR-02 | Generate ADR with alternatives | P0 |
| ADR-03 | Auto-numbering works correctly | P1 |
| ADR-04 | Status validation (enum) | P0 |
| ADR-05 | padNumber helper formats correctly | P1 |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type:** Tooling/Templates
**Secondary Type(s):** Documentation, Architecture
**Complexity:** Low (template creation)

### Specialized Agent Assignment

**Primary Agents:**
- @dev: Template implementation

**Supporting Agents:**
- @architect: ADR format review

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run ADR-01 to ADR-05 tests
- [ ] Pre-PR (@github-devops): Validate template syntax

### Self-Healing Configuration

**Expected Self-Healing:**
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 10 minutes
- Severity Filter: CRITICAL only

**Predicted Behavior:**
- CRITICAL issues: Auto-fix
- HIGH issues: Document only

### Focus Areas

**Primary Focus:**
- ADR format compliance (Context, Decision, Consequences)
- Schema validation (required fields)

**Secondary Focus:**
- Helper functions (padNumber, add)

---

## Dependencies

**Depends on:**
- Story 3.6 (Template Engine Core) ‚è≥

**Blocks:**
- Story 3.12 (Documentation Sprint 3)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Template generates valid ADR
- [ ] ADR-01 to ADR-05 tests pass
- [ ] QA Review passed
- [ ] PR created and approved

---

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Completion Notes
_To be populated during implementation_

### File List
_To be populated during implementation_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Story created (in bundled file) | River |
| 2025-12-03 | 2.0 | Separated into individual story file | Pax (@po) |

---

## QA Results

_To be populated after implementation_

---

**Created by:** River üåä
**Validated by:** Pax üéØ (PO)
