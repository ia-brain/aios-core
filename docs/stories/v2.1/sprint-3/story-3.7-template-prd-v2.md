# STORY 3.7: Template PRD v2.0

**ID:** 3.7 | **Epic:** [EPIC-S3](../../../epics/epic-s3-quality-templates.md)
**Sprint:** 3 | **Points:** 3 | **Priority:** üü† High | **Created:** 2025-01-19
**Updated:** 2025-12-03
**Status:** üìã Draft

**Reference:** [Decis√£o 9 - Template Engine](../../../audits/PEDRO-DECISION-LOG.md#decis√£o-9)

**Predecessor:** Story 3.6 (Template Engine Core) ‚è≥

---

## User Story

**Como** PO (Pax),
**Quero** template PRD v2.0 em formato Handlebars,
**Para que** possa gerar PRDs completos, consistentes e validados automaticamente.

---

## Acceptance Criteria

### Template Structure
- [ ] AC3.7.1: Template inclui todas se√ß√µes obrigat√≥rias do PRD
- [ ] AC3.7.2: Vari√°veis claramente definidas com tipos e defaults
- [ ] AC3.7.3: Condicionais para se√ß√µes opcionais (UI/UX, Brownfield)
- [ ] AC3.7.4: Helpers para formata√ß√£o de datas e listas

### Validation
- [ ] AC3.7.5: JSON Schema valida output gerado
- [ ] AC3.7.6: Erros de valida√ß√£o com mensagens claras

### Integration
- [ ] AC3.7.7: Template registrado no TemplateEngine
- [ ] AC3.7.8: Gera√ß√£o via CLI: `aios generate prd`

---

## Scope

### Template Location
`.aios-core/product/templates/prd-v2.0.hbs`

### Template Structure

```handlebars
---
template_id: prd-v2.0
template_name: Product Requirements Document
version: 2.0
variables:
  - name: projectName
    type: string
    required: true
    prompt: "Nome do projeto:"
  - name: productName
    type: string
    required: true
    prompt: "Nome do produto:"
  - name: version
    type: string
    default: "1.0.0"
  - name: author
    type: string
    required: true
  - name: problemStatement
    type: text
    required: true
    prompt: "Qual problema estamos resolvendo?"
  - name: goals
    type: array
    required: true
    minItems: 1
  - name: userStories
    type: array
    required: true
  - name: includeUIUX
    type: boolean
    default: false
  - name: isBrownfield
    type: boolean
    default: false
---

# Product Requirements Document - {{projectName}}

## Overview

**Product:** {{productName}}
**Version:** {{version}}
**Author:** {{author}}
**Date:** {{formatDate now "YYYY-MM-DD"}}
**Status:** Draft

---

## 1. Problem Statement

{{problemStatement}}

---

## 2. Goals & Objectives

{{#each goals}}
- {{this}}
{{/each}}

---

## 3. User Stories

{{#each userStories}}
### US{{@index}}: {{this.title}}

**As** {{this.actor}},
**I want** {{this.action}},
**So that** {{this.benefit}}.

**Acceptance Criteria:**
{{#each this.criteria}}
- [ ] {{this}}
{{/each}}

{{/each}}

---

## 4. Functional Requirements

{{#each functionalRequirements}}
### FR{{@index}}: {{this.title}}

{{this.description}}

**Priority:** {{this.priority}}
{{/each}}

---

## 5. Non-Functional Requirements

{{#each nonFunctionalRequirements}}
- **{{this.category}}:** {{this.requirement}}
{{/each}}

---

{{#if includeUIUX}}
## 6. UI/UX Requirements

### User Flows
{{#each userFlows}}
- {{this}}
{{/each}}

### Design Considerations
{{designConsiderations}}

---
{{/if}}

{{#if isBrownfield}}
## 7. Brownfield Considerations

### Existing System Analysis
{{existingSystemAnalysis}}

### Integration Points
{{#each integrationPoints}}
- {{this}}
{{/each}}

### Migration Strategy
{{migrationStrategy}}

---
{{/if}}

## 8. Success Metrics

| Metric | Target | Measurement Method |
|--------|--------|-------------------|
{{#each successMetrics}}
| {{this.metric}} | {{this.target}} | {{this.method}} |
{{/each}}

---

## 9. Timeline & Milestones

{{#each milestones}}
- **{{this.name}}:** {{this.date}}
{{/each}}

---

## 10. Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
{{#each risks}}
| {{this.risk}} | {{this.impact}} | {{this.probability}} | {{this.mitigation}} |
{{/each}}

---

**Generated by:** AIOS Template Engine v2.0
**Template Version:** prd-v2.0
```

### JSON Schema

`.aios-core/product/templates/engine/schemas/prd.schema.json`:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PRD Template Variables",
  "type": "object",
  "required": ["projectName", "productName", "author", "problemStatement", "goals", "userStories"],
  "properties": {
    "projectName": { "type": "string", "minLength": 1 },
    "productName": { "type": "string", "minLength": 1 },
    "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
    "author": { "type": "string", "minLength": 1 },
    "problemStatement": { "type": "string", "minLength": 50 },
    "goals": {
      "type": "array",
      "minItems": 1,
      "items": { "type": "string" }
    },
    "userStories": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["title", "actor", "action", "benefit"],
        "properties": {
          "title": { "type": "string" },
          "actor": { "type": "string" },
          "action": { "type": "string" },
          "benefit": { "type": "string" },
          "criteria": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "includeUIUX": { "type": "boolean" },
    "isBrownfield": { "type": "boolean" }
  }
}
```

---

## Tasks

### Design (2h)
- [ ] 3.7.1: Design PRD v2.0 structure
  - [ ] 3.7.1.1: Review existing PRD templates in codebase
  - [ ] 3.7.1.2: Define required vs optional sections
  - [ ] 3.7.1.3: Document variable schema

### Implementation (5h)
- [ ] 3.7.2: Create Handlebars template (3h)
  - [ ] 3.7.2.1: Create base template structure
  - [ ] 3.7.2.2: Add conditionals for optional sections
  - [ ] 3.7.2.3: Add Handlebars helpers for formatting
- [ ] 3.7.3: Define variable schema (2h)
  - [ ] 3.7.3.1: Create JSON Schema file
  - [ ] 3.7.3.2: Define elicitation prompts
  - [ ] 3.7.3.3: Add validation rules

### Testing (2h)
- [ ] 3.7.4: Test generation
  - [ ] 3.7.4.1: Generate sample PRD with all sections
  - [ ] 3.7.4.2: Test conditional sections (UI/UX, Brownfield)
  - [ ] 3.7.4.3: Validate output against schema

**Total Estimated:** 9h (~1 day)

---

## Dev Notes

### Existing PRD Templates
- `docs/prd.md` - Current PRD location
- `.aios-core/product/templates/prd-tmpl.md` - Existing template (if any)

### Handlebars Helpers Required
```javascript
// formatDate helper
Handlebars.registerHelper('formatDate', (date, format) => {
  return dayjs(date).format(format);
});

// now helper (current date)
Handlebars.registerHelper('now', () => new Date());
```

### Testing

**Test Location:** `tests/template-engine/`
**Test Scenarios:**

| Test ID | Name | Priority |
|---------|------|----------|
| PRD-01 | Generate PRD with required fields only | P0 |
| PRD-02 | Generate PRD with UI/UX section | P0 |
| PRD-03 | Generate PRD with Brownfield section | P0 |
| PRD-04 | Validation fails on missing required field | P0 |
| PRD-05 | Variable elicitation prompts correctly | P1 |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type:** Tooling/Templates
**Secondary Type(s):** Documentation
**Complexity:** Low-Medium (template creation)

### Specialized Agent Assignment

**Primary Agents:**
- @dev: Template implementation

**Supporting Agents:**
- @po: Template content review

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run PRD-01 to PRD-05 tests
- [ ] Pre-PR (@github-devops): Validate template syntax

### Self-Healing Configuration

**Expected Self-Healing:**
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 10 minutes
- Severity Filter: CRITICAL only

**Predicted Behavior:**
- CRITICAL issues: Auto-fix (schema validation errors)
- HIGH issues: Document only

### Focus Areas

**Primary Focus:**
- Template syntax correctness (Handlebars)
- Schema completeness (all required fields)
- Conditional logic (UI/UX, Brownfield)

**Secondary Focus:**
- Output formatting (markdown validity)
- Helper function correctness

---

## Dependencies

**Depends on:**
- Story 3.6 (Template Engine Core) ‚è≥

**Blocks:**
- Story 3.12 (Documentation Sprint 3)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Template generates valid PRD
- [ ] JSON Schema validates output
- [ ] PRD-01 to PRD-05 tests pass
- [ ] QA Review passed
- [ ] PR created and approved

---

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Completion Notes
_To be populated during implementation_

### File List
_To be populated during implementation_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Story created (in bundled file) | River |
| 2025-12-03 | 2.0 | Separated into individual story file | Pax (@po) |

---

## QA Results

_To be populated after implementation_

---

**Created by:** River üåä
**Validated by:** Pax üéØ (PO)
